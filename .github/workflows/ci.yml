name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          make \
          libelf-dev \
          zlib1g-dev \
          pkg-config \
          build-essential \
          linux-headers-$(uname -r) \
          libbpf-dev

    - name: Install bpftool
      run: |
        # Install bpftool from kernel sources
        sudo apt-get install -y \
          libcap-dev \
          libpcap-dev \
          libbfd-dev \
          binutils-dev \
          libreadline-dev \
          libssl-dev \
          libnuma-dev \
          cmake \
          ninja-build \
          llvm
        
        # Clone and build bpftool
        git clone --depth 1 --branch v6.6 https://github.com/torvalds/linux.git /tmp/linux
        cd /tmp/linux/tools/bpf/bpftool
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Verify bpftool installation
      run: |
        bpftool --version
        which bpftool

    - name: Build application
      run: |
        make clean
        make

    - name: Verify build artifacts
      run: |
        ls -la build/
        file build/sermon
        # Check if the binary is executable
        test -x build/sermon

    - name: Test basic functionality
      run: |
        # Verify binary properties (not executing eBPF programs on runner)
        echo "Binary verification:"
        file build/sermon
        echo "Binary size: $(stat -c%s build/sermon) bytes"
        echo "Binary permissions: $(stat -c%a build/sermon)"
        
        # Test that required libraries are linked
        ldd build/sermon

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tty-egpf-monitor-build
        path: |
          build/sermon
          build/sniffer.bpf.o
          build/sniffer.skel.h
          build/vmlinux.h
        retention-days: 7


